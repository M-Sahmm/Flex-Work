<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Inventory Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='1.0') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="notification" class="notification"></div>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
                <div class="user-profile-info">
                    <h3>{{ username }}</h3>
                </div>
            </div>

            <div class="sidebar-nav">
                <span class="nav-section-title">Navigation</span>
                <a href="{{ url_for('dashboard') }}" class="nav-button">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="{{ url_for('groups') }}" class="nav-button">
                    <i class="fas fa-users"></i> Groups
                </a>
                <a href="{{ url_for('inventory') }}" class="nav-button">
                    <i class="fas fa-boxes"></i> Inventory
                </a>
                <a href="{{ url_for('workpad') }}" class="nav-button">
                    <i class="fas fa-tasks"></i> WorkPad
                </a>
                <a href="{{ url_for('bulletin') }}" class="nav-button">
                    <i class="fas fa-clipboard"></i> Bulletin
                </a>
            </div>

            <div class="sidebar-footer">
                <a href="{{ url_for('account_manager') }}" class="nav-button">
                    <i class="fas fa-cog"></i> Settings
                </a>
                <form action="{{ url_for('logout') }}" method="POST" class="logout-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="nav-button">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </div>

        <div class="main-content">
            <div class="dashboard-header">
                <h1><i class="fas fa-boxes"></i> Inventory Management</h1>
            </div>
            
            <div class="page-actions">
                <button class="action-button" onclick="showAddItemModal()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
                <button class="action-button" onclick="showCreateWorkGroupModal()">
                    <i class="fas fa-layer-group"></i> Create Work Group
                </button>
            </div>

            <div class="view-tabs">
                <button class="view-tab active" onclick="switchView('all')">
                    <i class="fas fa-th-list"></i> All Items
                </button>
                <button class="view-tab" onclick="switchView('groups')">
                    <i class="fas fa-layer-group"></i> Work Groups
                </button>
            </div>

            <div id="allItemsView" class="view-content active">
                <div class="inventory-grid" role="grid" aria-label="Inventory items">
                    {% for item in items %}
                    <div class="inventory-item" data-id="{{ item.id }}" role="gridcell" onclick="toggleItemMenu(event, '{{ item.id }}')">
                        {% if item.file_type == 'pdf' %}
                            <i class="fas fa-file-pdf file-icon pdf"></i>
                        {% elif item.file_type == 'docx' %}
                            <i class="fas fa-file-word file-icon docx"></i>
                        {% elif item.file_type == 'csv' %}
                            <i class="fas fa-file-csv file-icon csv"></i>
                        {% elif item.file_type == 'url' %}
                            <i class="fas fa-link file-icon url"></i>
                        {% endif %}
                        <div class="name">{{ item.name }}</div>
                        <div class="type">{{ item.file_type.upper() }}</div>
                        <div class="date">{{ item.date_added.split('.')[0] }}</div>
                        <button type="button" class="delete-btn" onclick="deleteItem(event, '{{ item.id|e }}')" aria-label="Delete {{ item.name|e }}">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                        
                        <!-- Item Options Menu -->
                        <div class="item-menu" id="menu-{{ item.id }}">
                            {% if item.file_type == 'url' %}
                            <a href="{{ item.url }}" class="menu-item" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Open
                            </a>
                            {% else %}
                            <a href="{{ url_for('download_file', item_id=item.id) }}" class="menu-item">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <button class="menu-item" onclick="showPreviewModal('{{ item.id }}', '{{ item.name }}', '{{ item.file_type }}')">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            {% endif %}
                            <button class="menu-item" onclick="showWorkGroupMenu(event, '{{ item.id }}')">
                                <i class="fas fa-layer-group"></i> Add to Work Group
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="workGroupsView" class="view-content">
                <div id="workGroupPanels">
                    <!-- Work group panels will be dynamically loaded here -->
                </div>
            </div>
        </div>

        <button type="button" class="add-item-button" onclick="showAddItemModal()" aria-label="Add new item">
            <i class="fas fa-plus" aria-hidden="true"></i>
        </button>
    </div>

    <!-- Work Group Menu -->
    <div id="workGroupMenu" class="work-group-menu">
        <div class="menu-header">
            <span>Move to Work Group</span>
        </div>
        <div class="menu-list">
            <!-- Work groups will be dynamically added here -->
        </div>
        <button class="create-group" onclick="showCreateWorkGroupModal()">
            <i class="fas fa-plus"></i>
            Create New Group
        </button>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal" role="dialog">
        <div class="modal-content">
            <h3><i class="fas fa-plus-circle"></i> Add New Item</h3>
            <div class="form-tabs">
                <button type="button" class="form-tab active" onclick="switchTab('file')">Upload File</button>
                <button type="button" class="form-tab" onclick="switchTab('url')">Add URL</button>
            </div>

            <!-- File Upload Form -->
            <div id="fileTab" class="tab-content active">
                <form id="fileUploadForm" class="add-item-form" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="file_type" value="file">
                    <div class="form-group">
                        <label for="fileName">Name</label>
                        <input type="text" id="fileName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="fileUpload">File (PDF, DOCX, or CSV)</label>
                        <input type="file" id="fileUpload" name="file" accept=".pdf,.docx,.csv" required>
                    </div>
                    <div class="form-group">
                        <label for="fileDescription">Description (optional)</label>
                        <textarea id="fileDescription" name="description"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="form-button" onclick="hideAddItemModal()">Cancel</button>
                        <button type="submit" class="form-button">Upload</button>
                    </div>
                </form>
            </div>

            <!-- URL Form -->
            <div id="urlTab" class="tab-content">
                <form id="urlForm" class="add-item-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="file_type" value="url">
                    <div class="form-group">
                        <label for="urlName">Name</label>
                        <input type="text" id="urlName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="url">URL</label>
                        <input type="url" id="url" name="url" required>
                    </div>
                    <div class="form-group">
                        <label for="urlDescription">Description (optional)</label>
                        <textarea id="urlDescription" name="description"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="form-button" onclick="hideAddItemModal()">Cancel</button>
                        <button type="submit" class="form-button">Add URL</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Work Group Modal -->
    <div id="createWorkGroupModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-layer-group"></i> Create New Work Group</h3>
            <form id="createWorkGroupForm" class="add-item-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="groupDescription">Description (Optional)</label>
                    <textarea id="groupDescription" name="description"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="form-button" onclick="hideCreateWorkGroupModal()">Cancel</button>
                    <button type="submit" class="form-button">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content preview-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> <span id="previewFileName"></span></h3>
                <button type="button" class="close-modal" onclick="closePreviewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="previewLoading" class="preview-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading preview...
                </div>
                <div id="previewError" class="preview-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p id="previewErrorMessage">Unable to load preview</p>
                </div>
                <div id="previewContent" class="preview-content"></div>
            </div>
        </div>
    </div>

    <script>
        // File Upload
        document.getElementById('fileUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            try {
                const response = await fetch('/add_inventory_item', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                showNotification('File uploaded successfully');
                hideAddItemModal();
                location.reload();
            } catch (error) {
                showNotification('Failed to upload file', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });

        // URL Form
        document.getElementById('urlForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/add_inventory_item', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                let data;
                try {
                    data = await response.json();
                } catch {
                    console.warn("Server response is not JSON.");
                    throw new Error(`Unexpected server response: ${await response.text()}`);
                }

                if (!response.ok) {
                    throw new Error(data?.error || `HTTP error! Status: ${response.status}`);
                }

                showNotification(data.message);
                hideAddItemModal();
                location.reload();

            } catch (error) {
                console.error('URL submission error:', error);
                showNotification(error.message || 'Failed to add item', 'error');
            }

        });

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }

        // Modal Management
        function showAddItemModal() {
            const modal = document.getElementById('addItemModal');
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        function hideAddItemModal() {
            const modal = document.getElementById('addItemModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        function showCreateWorkGroupModal() {
            const modal = document.getElementById('createWorkGroupModal');
            modal.classList.add('show');
            
            // Don't close the work group menu when the modal is open
            document.removeEventListener('click', closeWorkGroupMenu);
        }

        function hideCreateWorkGroupModal() {
            const modal = document.getElementById('createWorkGroupModal');
            modal.classList.remove('show');
            
            // Re-add the click event listener for the work group menu
            document.addEventListener('click', closeWorkGroupMenu);
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                hideAddItemModal();
            }
        });

        function toggleItemMenu(event, itemId) {
            // Don't toggle if clicking delete button
            if (event.target.closest('.delete-btn')) {
                return;
            }
            
            // Close all other menus
            document.querySelectorAll('.item-menu').forEach(menu => {
                if (menu.id !== `menu-${itemId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle clicked menu
            const menu = document.getElementById(`menu-${itemId}`);
            menu.classList.toggle('show');
            
            // Stop event propagation
            event.stopPropagation();
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.inventory-item')) {
                document.querySelectorAll('.item-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Preview functionality
        // Update menu item click handlers
        document.querySelectorAll('.menu-item').forEach(button => {
            if (button.querySelector('i.fa-eye')) {
                button.onclick = function(e) {
                    e.stopPropagation();
                    const item = this.closest('.inventory-item');
                    const itemId = item.dataset.id;
                    const itemName = item.querySelector('.name').textContent;
                    // Get file type, remove any whitespace with trim(), and convert from uppercase to lowercase
                    const fileType = item.querySelector('.type').textContent.trim().toLowerCase();
                    showPreviewModal(itemId, itemName, fileType);
                };
            }
        });

        // Work Group functionality
        let currentItemForWorkGroup = null;
        
        async function loadWorkGroups() {
            try {
                const response = await fetch('/work_groups', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const menuList = document.querySelector('.work-group-menu .menu-list');
                    menuList.innerHTML = '';

                    if (data.groups && data.groups.length > 0) {
                        data.groups.forEach(group => {
                            const item = document.createElement('div');
                            item.className = 'menu-item';
                            item.onclick = () => moveToWorkGroup(group.id);
                            item.innerHTML = `
                                <i class="fas fa-layer-group"></i>
                                ${group.name}
                            `;
                            menuList.appendChild(item);
                        });
                    } else {
                        menuList.innerHTML = '<div class="menu-item no-groups">No work groups yet</div>';
                    }
                } else {
                    showNotification('Failed to load work groups', 'error');
                }
            } catch (error) {
                console.error('Error loading work groups:', error);
                showNotification('Failed to load work groups', 'error');
            }
        }

        function showWorkGroupMenu(event, itemId) {
            event.stopPropagation();
            currentItemForWorkGroup = itemId;
            
            const menu = document.getElementById('workGroupMenu');
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            // Position the menu below the button
            menu.style.top = rect.bottom + window.scrollY + 'px';
            menu.style.left = rect.left + window.scrollX + 'px';
            
            // Show the menu
            menu.classList.add('show');
            
            // Load work groups
            loadWorkGroups();
            
            // Add click event listener to close menu when clicking outside
            document.addEventListener('click', closeWorkGroupMenu);
        }
        
        function closeWorkGroupMenu(event) {
            const menu = document.getElementById('workGroupMenu');
            const createGroupModal = document.getElementById('createWorkGroupModal');
            
            // Don't close if clicking inside the menu or the create group modal
            if (event && (menu.contains(event.target) || createGroupModal.contains(event.target))) {
                return;
            }
            
            menu.classList.remove('show');
            document.removeEventListener('click', closeWorkGroupMenu);
        }

        async function moveToWorkGroup(groupId) {
            try {
                if (!currentItemForWorkGroup) {
                    showNotification('No item selected', 'warning');
                    return;
                }

                const response = await fetch(`/work_groups/${groupId}/items`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ item_id: currentItemForWorkGroup })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error;
                    } catch {
                        errorMessage = 'Failed to move item to work group';
                        console.error('Error response:', errorText);
                    }
                    showNotification(errorMessage, 'error');
                    return;
                }

                // Hide the menu and show success message
                const menu = document.getElementById('workGroupMenu');
                menu.classList.remove('show');
                showNotification('Item moved to work group successfully', 'success');
                
                // Reset the current item
                currentItemForWorkGroup = null;
                
                // Refresh the page to show updated state
                window.location.reload();
            } catch (error) {
                console.error('Error moving item to work group:', error);
                showNotification('Failed to move item to work group', 'error');
            }
        }

        async function loadWorkGroupPanels() {
            try {
                const response = await fetch('/work_groups', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load work groups');
                }
                
                const data = await response.json();
                const panelsContainer = document.getElementById('workGroupPanels');
                
                if (!data.groups || data.groups.length === 0) {
                    panelsContainer.innerHTML = '<p class="text-center">No work groups found. Create one to get started!</p>';
                    return;
                }
                
                const panelsHtml = await Promise.all(data.groups.map(async group => {
                    // Get items for this group
                    const itemsResponse = await fetch(`/work_groups/${group.id}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (!itemsResponse.ok) {
                        throw new Error(`Failed to load items for group ${group.id}`);
                    }
                    
                    const groupData = await itemsResponse.json();
                    const items = groupData.group.items || [];
                    
                    return `
                        <div class="work-group-panel" data-group-id="${group.id}">
                            <div class="work-group-header">
                                <div class="work-group-title">${group.name}</div>
                                <div class="work-group-actions">
                                    <button class="btn small" onclick="editWorkGroup(${group.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn small danger" onclick="deleteWorkGroup(${group.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${group.description ? `<div class="work-group-description">${group.description}</div>` : ''}
                            <div class="work-group-items" id="group-${group.id}-items">
                                ${items.length === 0 ? 
                                    '<p class="text-center">No items in this group yet.</p>' : 
                                    '<div class="items-container"></div>'
                                }
                            </div>
                        </div>
                    `;
                }));
                
                panelsContainer.innerHTML = panelsHtml.join('');

                // Move inventory items to their respective work groups
                data.groups.forEach(async group => {
                    const itemsResponse = await fetch(`/work_groups/${group.id}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (itemsResponse.ok) {
                        const groupData = await itemsResponse.json();
                        const items = groupData.group.items || [];
                        const container = document.querySelector(`#group-${group.id}-items .items-container`);
                        
                        if (container) {
                            items.forEach(item => {
                                const inventoryItem = document.querySelector(`.inventory-item[data-id="${item.id}"]`);
                                if (inventoryItem) {
                                    // Update the move to group button to be remove from group
                                    const moveButton = inventoryItem.querySelector('.menu-item[data-action="move"]');
                                    if (moveButton) {
                                        moveButton.innerHTML = '<i class="fas fa-times"></i> Remove from Group';
                                        moveButton.setAttribute('data-action', 'remove');
                                        moveButton.onclick = () => removeFromWorkGroup(group.id, item.id);
                                    }
                                    container.appendChild(inventoryItem);
                                }
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading work groups:', error);
                showNotification('Failed to load work groups', 'error');
            }
        }

        // Function to switch between views
        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.remove('active');
            });

            if (view === 'all') {
                document.querySelector('.view-tab:first-child').classList.add('active');
                document.getElementById('allItemsView').classList.add('active');
                // Move all items back to the all items view
                document.querySelectorAll('.work-group-items .inventory-item').forEach(item => {
                    const allItemsContainer = document.querySelector('#allItemsView .inventory-grid');
                    if (allItemsContainer) {
                        // Reset the move to group button
                        const moveButton = item.querySelector('.menu-item[data-action="remove"]');
                        if (moveButton) {
                            moveButton.innerHTML = '<i class="fas fa-folder-plus"></i> Move to Group';
                            moveButton.setAttribute('data-action', 'move');
                            moveButton.onclick = (e) => showWorkGroupMenu(e, item.getAttribute('data-id'));
                        }
                        allItemsContainer.appendChild(item);
                    }
                });
            } else {
                document.querySelector('.view-tab:last-child').classList.add('active');
                document.getElementById('workGroupsView').classList.add('active');
                loadWorkGroupPanels();
            }
        }

        function getFileIcon(fileType) {
            switch (fileType) {
                case 'pdf': return 'file-pdf';
                case 'docx': return 'file-word';
                case 'csv': return 'file-csv';
                case 'url': return 'link';
                default: return 'file';
            }
        }

        // Add these new functions for work group management
        async function editWorkGroup(groupId) {
            // TODO: Implement work group editing
        }

        async function deleteWorkGroup(groupId) {
            if (!confirm('Are you sure you want to delete this work group? This will remove all items from the group.')) return;
            
            try {
                const response = await fetch(`/work_groups/${groupId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    showNotification('Work group deleted successfully');
                    // Refresh both the work group panels and the main inventory view
                    await loadWorkGroupPanels();
                    if (typeof loadInventoryItems === 'function') {
                        await loadInventoryItems();
                    }
                } else {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error;
                    } catch {
                        errorMessage = 'Failed to delete work group';
                        console.error('Error response:', errorText);
                    }
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error deleting work group:', error);
                showNotification('Failed to delete work group', 'error');
            }
        }

        async function removeFromWorkGroup(groupId, itemId) {
            try {
                const response = await fetch(`/work_groups/${groupId}/items/${itemId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });
                
                if (response.ok) {
                    showNotification('Item removed from work group');
                    loadWorkGroupPanels();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to remove item from work group', 'error');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                showNotification('Failed to remove item from work group', 'error');
            }
        }

        async function deleteItem(event, itemId) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                const response = await fetch(`/delete_inventory_item/${itemId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    showNotification('Item deleted successfully');
                    // Refresh both views to ensure consistency
                    if (typeof loadInventoryItems === 'function') {
                        await loadInventoryItems();
                    }
                    await loadWorkGroupPanels();
                } else {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error;
                    } catch {
                        errorMessage = 'Failed to delete item';
                        console.error('Error response:', errorText);
                    }
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('Failed to delete item', 'error');
            }
        }

        function showPreviewModal(itemId, itemName, fileType) {
            const modal = document.getElementById('previewModal');
            const fileName = document.getElementById('previewFileName');
            const loading = document.getElementById('previewLoading');
            const error = document.getElementById('previewError');
            const content = document.getElementById('previewContent');
            
            fileName.textContent = itemName;
            loading.style.display = 'flex';
            error.style.display = 'none';
            content.innerHTML = '';
            
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            // Fetch preview content
            fetch(`/preview/${itemId}`, { credentials: 'same-origin' })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load preview');
                    // For PDFs, we receive the file directly
                    if (fileType === 'pdf') {
                        loading.style.display = 'none';
                        content.innerHTML = `<embed src="/preview/${itemId}" type="application/pdf" width="100%" height="100%">`;
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Skip if we already handled PDF
                    loading.style.display = 'none';
                    
                    switch(fileType) {
                        case 'pdf':
                            content.innerHTML = `<embed src="/preview/${itemId}" type="application/pdf" width="100%" height="100%">`;
                            break;
                        case 'docx':
                            content.innerHTML = data.html;
                            break;
                        case 'csv':
                            content.innerHTML = data.html;
                            break;
                        default:
                            throw new Error('Unsupported file type');
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.style.display = 'flex';
                    document.getElementById('previewErrorMessage').textContent = 'Unable to load preview: ' + err.message;
                });
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
            });
        });

        // Handle work group creation
        document.getElementById('createWorkGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    name: document.getElementById('groupName').value,
                    description: document.getElementById('groupDescription').value
                };
                
                const response = await fetch('/work_groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create work group');
                }
                
                const data = await response.json();
                showNotification('Work group created successfully', 'success');
                hideCreateWorkGroupModal();
                
                // Clear form
                document.getElementById('createWorkGroupForm').reset();
                
                // Refresh work groups list
                await loadWorkGroups();
                await loadWorkGroupPanels();
            } catch (error) {
                console.error('Error creating work group:', error);
                showNotification(error.message, 'error');
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.form-tab').forEach(button => button.classList.remove('active'));
            
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
    </script>
</body>
</html>